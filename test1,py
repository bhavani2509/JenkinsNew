End-to-End k6 CI/CD – Full Working Code

REPOSITORY STRUCTURE
====================
repo-root/
├── .github/workflows/k6-load-test.yml
├── test.js
└── test.sh


----------------------------------------
1. GitHub Actions Workflow
File: .github/workflows/k6-load-test.yml
----------------------------------------

name: k6 End-to-End CI/CD

on:
  push:
    branches:
      - feature/k6
  workflow_dispatch:
    inputs:
      ESP_ENV:
        description: Environment label
        required: true
        type: choice
        options: [non-prod, prod]
        default: non-prod
      VUS:
        description: Virtual users
        required: true
        default: "5"
      DURATION:
        description: Test duration
        required: true
        default: "30s"
      TARGET_URL:
        description: URL to test
        required: true
        default: "https://example.com"

permissions:
  contents: read

jobs:
  k6_ci_cd:
    runs-on: ubuntu-latest

    env:
      ESP_ENV: ${{ github.event.inputs.ESP_ENV }}
      VUS: ${{ github.event.inputs.VUS }}
      DURATION: ${{ github.event.inputs.DURATION }}
      TARGET_URL: ${{ github.event.inputs.TARGET_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Docker
        run: |
          if ! command -v docker >/dev/null 2>&1; then
            curl -fsSL https://get.docker.com | sudo sh
          fi
          docker version

      - name: Verify test.js exists
        run: |
          pwd
          ls -la
          find . -name test.js

      - name: Run k6 (bulletproof)
        run: |
          set -e
          TEST_FILE=$(find . -name test.js | head -n 1)
          if [ -z "$TEST_FILE" ]; then
            echo "test.js not found"
            exit 1
          fi

          docker run --rm             -e VUS="$VUS"             -e DURATION="$DURATION"             -e TARGET_URL="$TARGET_URL"             -v "$GITHUB_WORKSPACE:/scripts"             -w /scripts             grafana/k6:latest run "$TEST_FILE"


----------------------------------------
2. k6 Test Script
File: test.js
----------------------------------------

import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  vus: __ENV.VUS ? parseInt(__ENV.VUS) : 5,
  duration: __ENV.DURATION || '30s',
  thresholds: {
    http_req_failed: ['rate<0.01'],
    http_req_duration: ['p(95)<2000']
  }
};

export default function () {
  const url = __ENV.TARGET_URL || 'https://example.com';
  const res = http.get(url);

  check(res, {
    'status is 200': (r) => r.status === 200,
  });

  sleep(1);
}


----------------------------------------
3. Local Execution Script (Optional)
File: test.sh
----------------------------------------

#!/usr/bin/env bash
set -e

export VUS=${VUS:-5}
export DURATION=${DURATION:-30s}
export TARGET_URL=${TARGET_URL:-https://example.com}

docker run --rm   -e VUS="$VUS"   -e DURATION="$DURATION"   -e TARGET_URL="$TARGET_URL"   -v "$(pwd):/scripts"   -w /scripts   grafana/k6:latest run test.js


----------------------------------------
HOW TO RUN
----------------------------------------

1. Push to feature/k6 branch
2. Or go to GitHub → Actions → Run workflow
3. Provide VUS, Duration, Target URL
4. Pipeline fails automatically if thresholds are breached

----------------------------------------
NOTES
----------------------------------------

- Works on GitHub-hosted runners
- Works on custom runners
- Avoids Docker path issues
- Production-grade setup

